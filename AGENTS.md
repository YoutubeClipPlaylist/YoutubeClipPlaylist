# AGENTS.md - AI Agent Instructions for YoutubeClipPlaylist

## Project Overview

**Youtube Clip Playlist** is a Chrome Extension that enables playing video clips with specified "start~end time" directly on YouTube, OneDrive, Google Drive, and TwitCasting. It is designed for listening to Vtuber singing streams (歌枠), allowing users to create playlists of song segments without downloading or re-uploading content.

### Key Benefits

- View counts are credited to the original videos
- Only requires cataloging start/end times (faster than video editing)
- No copyright issues since original content is not modified or republished

## Repository Structure

```text
YoutubeClipPlaylist/
├── src/                          # TypeScript source for Chrome Extension
│   ├── background.ts             # Service worker (background script)
│   ├── contentScript.ts          # Content script injected into pages
│   ├── popup.ts                  # Extension popup UI logic
│   ├── popup.html                # Popup HTML template
│   ├── Models/                   # TypeScript interfaces and types
│   └── Helper/                   # Utility modules (DOM, URL, Playlist helpers)
├── dist/                         # Build output (generated by webpack)
├── Playlists/                    # Git submodule - Playlist data repository
├── Lyrics/                       # Git submodule - Lyrics data repository
├── manifest.json                 # Chrome Extension manifest (MV3)
├── webpack.config.js             # Webpack build configuration
├── tsconfig.json                 # TypeScript compiler options
├── .eslintrc.json                # ESLint configuration
├── .prettierrc.json              # Prettier formatting rules
└── .github/workflows/            # CI/CD workflows
    ├── Upload.yml                # Build and upload to Chrome Web Store
    └── Publish.yml               # Publish release workflow
```

## Technology Stack

- **Language**: TypeScript (ES2021+)
- **Build Tool**: Webpack 5
- **UI Framework**: Bootstrap 5
- **Extension Type**: Chrome Extension Manifest V3
- **Linting**: ESLint with TypeScript parser
- **Formatting**: Prettier
- **Subtitle Support**: ASS.js for ASS subtitles, native WebVTT, LRC lyrics

## Build & Development

### Prerequisites

- Node.js (version 16.3.0 recommended for CI compatibility)
- npm

### Commands

```bash
# Install dependencies
npm install

# Build for production
npm run build

# Build for development (with source maps)
npm run build:dev
```

### Build Output

The build produces files in the `dist/` directory, which can be loaded as an unpacked extension in Chrome.

## Code Style & Conventions

### TypeScript

- Use **single quotes** for strings
- **4 spaces** for indentation (no tabs)
- **100 character** line width
- Trailing commas in ES5 style
- Semicolons required
- All code comments and annotations must be in **English**

### File Naming

- TypeScript source files: `camelCase.ts`
- Model/Interface files: `PascalCase.ts` (e.g., `Message.ts`, `Playlist.ts`)
- Helper modules: `PascalCaseHelper.ts`

### ESLint Rules

- Extends `eslint:recommended` and `@typescript-eslint/recommended`
- Integrates with Prettier via `eslint-config-prettier`

### Prettier Configuration

The project uses Prettier with the following key settings (see `.prettierrc.json`):

- `tabWidth`: 4
- `singleQuote`: true
- `trailingComma`: "es5"
- `printWidth`: 100
- YAML files use 2-space indentation

## Architecture Notes

### Chrome Extension Components

1. **Background Script** (`background.ts`): Service worker handling message passing and playlist management
2. **Content Script** (`contentScript.ts`): Injected into video pages to control playback timing
3. **Popup** (`popup.ts`, `popup.html`): Extension UI for playlist selection and settings

### Message Passing

The extension uses Chrome's `chrome.runtime.sendMessage` API for communication between components. Message types are defined in `src/Models/Message.ts`.

### Playlist Format

Playlists are stored as JSONC (JSON with comments) files. Each song entry is an array:

```jsonc
[VideoID, StartTime, EndTime, Title?, SubSrc?]
```

- `VideoID`: string - YouTube/platform video identifier
- `StartTime`: number - Start time in seconds (0 = from beginning)
- `EndTime`: number - End time in seconds (0 = until end)
- `Title`: string (optional) - Song title
- `SubSrc`: string (optional) - Subtitle/lyric source URL

### URL Parameters

The extension is driven by URL parameters:

- `startplaylist`: Activates playlist mode
- `t`: Video start time
- `end`: Video end time
- `shuffle`: Enable random playback (1/0)
- `playlist`: Play specific playlist
- `playlistinclude` / `playlistexclude`: Tag-based filtering

## Git Submodules

This repository contains two submodules:

1. **Playlists** (`Playlists/`): Contains playlist JSONC files organized by artist
2. **Lyrics** (`Lyrics/`): Contains lyrics data fetched from external sources

> [!IMPORTANT]
> When cloning, use `git clone --recurse-submodules` to fetch submodules.

## Legacy Code Warning

> [!CAUTION]
> The file `YoutubeClipPlaylist.user.js` is **legacy reference code** and should **NOT** be modified or touched. All active development uses the TypeScript source in `src/`.

## CI/CD Workflows

### Upload.yml

Triggered on version tags (`v*`). Builds the extension and uploads to Chrome Web Store.

### Publish.yml

Manual workflow for publishing releases with artifacts.

## Testing

Currently, there is no automated test suite. Manual testing is performed by loading the unpacked extension in Chrome.

## Related Repositories

- [YoutubeClipPlaylist/Playlists](https://github.com/YoutubeClipPlaylist/Playlists): Playlist data
- [YoutubeClipPlaylist/Lyrics](https://github.com/YoutubeClipPlaylist/Lyrics): Lyrics data with auto-fetch from NetEase Cloud Music

## License

GNU General Public License v3.0 (GPL-3.0)
